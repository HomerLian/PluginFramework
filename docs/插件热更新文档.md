# Android插件热更新文档
### SDK插件实现热更新原理：
> sdk工作原理是接入方接入sdk，然后根据sdk提供的方法去请求我们的广告以及去上报结果等等操作。如果单纯这种方式接入的情况下，当sdk需要新增或者修改需求的时候，媒体方需要重新去接入sdk，然后媒体重新发包，耗时耗力。

> 所以这时候引入热更新，热更新的原理将sdk插件化，sdk提供给媒体接入的仅是一个壳程序，**可以理解为sdk就是一个外壳程序**，真正的逻辑在壳程序中的插件包中，当媒体通过调用壳程序提供的方法去请求广告的时候，sdk（壳程序）其实是调用插件包中的对应方法去请求后台接口。这样的好处是，当有新需求需要改动或者新增的时候，只需要做一个插件包，然后将插件包上传后台，壳程序启动的时候默认先去后台请求这个插件包，然后就能调用实现新的功能了（当然并不是所有的功能都可以通过只修改插件来实现，下一段讲）。</br>
而sdk（壳程序）与插件包的交互原理是什么呢，其实就是sdk（壳程序）与插件包开放了一套一样的方法，这套方法理解为**交互方法**，用这套方法来互相通信。
![插件化交互原理](https://github.com/HomerLian/PluginHotFit/blob/master/%E6%8F%92%E4%BB%B6%E5%8C%96%E4%BA%A4%E4%BA%92%E5%8E%9F%E7%90%86.png)

> 当我们需要变动的需求如果直接在交互方法内部做就能满足的话，那只需要在插件包中做修改，然后替换插件就可以。但是当我们改动的功能需要同时修改插件包和外壳程序的话（比如需要新增交互方法或者修改交互方法的参数等这些操作），那么需要同时修改插件和sdk（外壳程序）才能实现。这就涉及到了版本兼容问题。
#### 问题描述：
![版本兼容问题](https://github.com/HomerLian/PluginHotFit/blob/master/%E7%89%88%E6%9C%AC%E5%85%BC%E5%AE%B9%E9%97%AE%E9%A2%981.png)
> 例如上面这种情况，当现在市面上有多个媒体分别接入了我们多个sdk版本，那么兼容问题就出现了，如果仅仅将最新的插件包返回给外壳的话，那后台持有的最高的插件是插件2.0，那么所有的媒体接入的sdk（壳程序）获取到的插件都是插件2.0。这时候市面上现有的媒体请求广告会有两种情况：

1. 媒体1请求广告时，因为媒体1所接入的sdk1.0（壳程序），那么请求广告的方法是getAd(type)，但是这时获取到的插件是插件2.0，那么就会出现插件中并没有对应的getAd(type)这个方法供sdk（壳程序）调用，因为插件2.0内部的getAd(type,pos)方法是两个参数的，这时就会报错
2. 媒体2请求广告时，因为媒体2接入的是sdk2.0，请求广告的方法是getAd(type,pos)，获取到的插件也是2.0，插件内部的方法就是getAd(type,pos)，这就没问题，一切正常。

所以因为上述原因，仅仅是返回最新的插件包是会出现问题的。会导致老版本的sdk（壳程序）报错

#### 解决方案：
在插件包中指明当前插件包所能支持的sdk（壳程序）的版本。所以这时候插件包中就有两个版本：

**plugin_vc：** 可以理解为正常咱们安装一个apk时候看到的apk版本号</br>
**compat_vc：** 这个插件包所能支持的外壳版本  
当我们上传插件时，指定这两个版本就能解决上述的版本兼容问题。
#### 后台逻辑：
后台的存储结构大致如下：

![后台存储结构](https://github.com/HomerLian/PluginHotFit/blob/master/%E5%90%8E%E5%8F%B0%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84.png)
**当我通过一个接口去请求插件或者更新插件的时候，会将现有的sdk（壳程序）版本号以及目前本地已有的插件版本号local_plugin_vc上传给后台。**

后台根据我上传的这两个版本号做如下操作：

1. 根据我上传的sdk版本号去到对应的compat_vc里面，比如我现在上传的sdk版本2,那么就到这个结构里面
![单个存储结构](https://github.com/HomerLian/PluginHotFit/blob/master/%E5%8D%95%E4%B8%AA%E7%BB%93%E6%9E%84.png)
2. 根据我上传的我当前本地所持有的插件版本号local_plugin_vc去比对compat_vc=2下的里面的插件的插件版本plugin_vc，如果plugin_vc > local_plugin_vc，那么返回一个该插件包的下载链接给sdk,这时sdk就使用对应的链接把插件下载下来，整个过程就结束了。

